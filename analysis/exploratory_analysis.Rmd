---
output:
  pdf_document: default
---
## Milestone 2 - Predict Flight Delays
### Tarin Eccleston

## 1. Goal

Flight delays are typically caused by weather conditions that disrupt airport operations and passenger travel plans. This project aims to gather historical flight and weather data to build models to predict if an upcoming flight will be delayed.

## 2. Data Source

I originally planned to collect flight data from either one of two APIs, FlightAware or FlightRadar24, however I found the API subscription for both these platforms to be expensive. I also planned to gather flight data for a random distribution of flights throughout the world, but decided to simplify my problem down to only domestic US flights. Firstly, the flight data will be more consistent and standardized as it is coming from a single country, with similar regulations and procedures. This makes it easier to analyze the data and develop accurate predictive models. Secondly, the domestic flight network in the US is extensive, with many major airports and airlines. This provides a large sample size for analysis and allows for the identification of patterns and trends in the data. Thirdly, focusing on domestic flights in the US eliminates the need to account for differences in international regulations, weather patterns, and other factors that can affect flight delays and cancellations. This simplifies the data exploration process and allows for more targeted analysis.

I instead found a good source on Kaggle, where a user collected flight data for 5.8 million flights in 2015. I wasn't able to find a dataset with flight data from the most recent years (2020 onwards), therefore I wouldn't be able to capture trends in flight delays due to the COVID-19 pandemic. The source included four datasets; flights, airports, airlines and cancellation reason. I was able to gain important information to identify if a flight was delayed by weather or for other reasons, and departure location and time information to collect weather data.

Weather data was collected from OpenWeather API. Weather data such as temperature, wind speed, precipitation, and visibility will be collected. For simplification, weather associated with the origin airport will only be extracted as it is assumed that the leading cause of weather flight delays is due to the immediate weather around the airport. After processing flight data, I created a random subset of 1000 weather delayed and 1000 non-weather delayed flights and exported that. I used a Python script to call the OpenWeather API for each flight, and return the associated weather data. The weather data is the ___ hr...

```{r}

```

## 3. Data Processing

Firstly, since we are trying to predict the delay in future flights based on weather data, I removed columns which don't appear of important to building our model and collecting data from the OpenWeather API. The flight delay is the difference in the scheduled time and time which the plane leaves the gate at the departure airport (departure time). This is usually caused by operational issues or weather delays. Therefore we can drop time information after the departure time such as taxi time, arrival time and flight time as these are not used in our investigation to predict flight delays. We also don't need information on whether the flight was diverted or not.

We have the flights, airlines, airport and cancellation reason dataframes. We will need to join all dataframes together to get relevant information about each flight. Inner join is used when you ______
I inner joined airlines data by airline code to get the carrier names, which is useful as we would like to investigate the occurrences of delays between each carrier. Next I inner joined the IATA code for departure and arrival airports to get airport information such as name, and coordinates. The coordinates departure airport coordinates are especially useful when getting weather data from OpenWeather. I then did a left join with cancellation reason to replace the cancellation code with a descriptive reason why the flight was cancelled. This information isn't too helpful in our analysis so I did a left join.

I combined delay times for air system, security, airline, and late aircraft delay and created another column called "OTHER_DELAY" as these delay times are caused by operational issues. I kept the "WEATHER_DELAY" column as is. Combing the columns simplifies the problem for our investigation as we don't need to seperature delay types for reasons which aren't related to weather for this study. If a flight is delayed for more than 15 minutes in "OTHER_DELAY" and / or "WEATHER_DELAY" it is classified as being delayed for that particular reason. 

The original dataframe has flight dates where the day, month and year is seperatured by columns. I combined them and created a datetime object as this can be better used in analysis. 
- Convert days of week to strings
- Converting time format
- Datetime objects

I created two subsets. One for cancellations as 
- Subset for cancellations
- Creating subset for weather data / analysis

## 4. Data Exploration

Let's take a quick look at our data...

```{r}
setwd("/Users/tarineccleston/Documents/Software:DS/predict-flight-delays")
library(tidyverse)
library(ggplot2)
library(ggmap)
library(maps)
library(skimr)

load("../output/flights.RData")
airports_df = read.csv("../data/airports.csv")
```

Summary of our data

```{r}
skim(flights_processed_df)
glimpse(flights_processed_df)
```

### 4.1 Question 1: How comprehensive is our data?

The US has a diverse range of airport locations and weather extremes. Although we have a large data set (5.8 million observations), we aim to understand how comprehensive our data is on domestic flights in the US, in order to better understand trends and limitations when building our predictive model. This map shows the distribution of airports and flight paths throughout the US. Having a diverse range of departure locations is important for capturing a range of weather conditions across the country.

Based on the map, it seems that the data is fairly comprehensive as it covers a large portion of the US and includes a significant number of flights between different airports. However, there are certain regions of the US where flight data appears to be more sparse, such as northern states, Alaska, and the New England region. This limitation in data coverage could affect the accuracy of the model in predicting flight delays for flights departing from those regions, or flights around the world which have similar weather. Additionally, the bias towards weather in the southern portion of the US could also limit the model's accuracy in predicting flight delays caused by weather conditions in other regions. Overall, while the data appears to be comprehensive in general, the limitations in data coverage and bias towards weather in certain regions should be taken into consideration when building the predictive model.

It's also worth noting that the data includes flights to and from island territories such as Hawaii, Puerto Rico, the US Virgin Islands, Guam, and American Samoa. These regions have unique weather patterns compared the mainland US, and can experience tropical storms, hurricanes, and other severe weather conditions, which could impact flight delays. Therefore, it's important to consider the weather conditions in these regions when building the model to ensure that it is comprehensive and accurate in predicting flight delays.

```{r}
usa = map_data("usa")

airports_df = na.omit(airports_df)

# create a frequency table for flight paths
flight_freq = flights_processed_df %>%
  group_by(ORIGIN_AIRPORT_CODE, DESTINATION_AIRPORT_CODE) %>%
  summarise(FLIGHT_FREQ = n()) %>%
  ungroup()

# merge frequency information with flixghts_processed_df
flights_frequency_df = flights_processed_df %>%
  left_join(flight_freq, by = c("ORIGIN_AIRPORT_CODE", "DESTINATION_AIRPORT_CODE")) %>%
  select(INDEX, ORIGIN_LONGITUDE, ORIGIN_LATITUDE, DESTINATION_LONGITUDE, DESTINATION_LATITUDE, FLIGHT_FREQ)

# Normalize the frequency values to [0, 1] range
flights_frequency_df = flights_frequency_df %>%
  mutate(FREQ_NORM = scales::rescale(FLIGHT_FREQ))

# create plot for each airport
airport_plot = ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group), fill = "white", colour = "black") +
  geom_point(data = airports_df, aes(x = LONGITUDE, y = LATITUDE, color = Airport), size = 0.1, colour = "red") +
  coord_fixed() +
  labs(title = "Flight Paths")

# plot flight paths on top of the airport plot
# plot flight paths on top of the airport plot
flight_plot = airport_plot + 
  geom_segment(data = flights_frequency_df, aes(x = ORIGIN_LONGITUDE, y = ORIGIN_LATITUDE, 
                                     xend = DESTINATION_LONGITUDE, yend = DESTINATION_LATITUDE, 
                                     alpha = FREQ_NORM), 
               color = "blue", linewidth = 0.01)

flight_plot
```

It is important to have uniformly distributed data across all days in 2015 in order to capture seasonal, weather and holiday patterns that might contribute to flight delays. There is a section of data missing from October 15th to November 15th. After investigating the pre-processing phase, it appears that observations between these two times have been originally included however each observation has numeric airport codes instead of IATA codes. These observations are removed after inner joining with the airports dataframe as we are joining by IATA code to get airport names and coordinates. Since we cannot associate the flights with airports between October 15th to November 15th, we cannot gather the weather data to build our model.

Extreme weather events such as hurricanes, tropical storms, and winter storms can occur during October 15th and November 15th. It is important to note this as it could affect our data analysis and model by causing some bias. However I believe this shouldn't be a problem as we have plenty of data from adjacent months to capture these extreme weather events.

```{r}
flights_processed_df$FLIGHT_DATETIME <- as.Date(flights_processed_df$FLIGHT_DATETIME)

ggplot(flights_processed_df, aes(x = FLIGHT_DATETIME)) +
  geom_histogram(binwidth = 1, color = "black", fill = "white") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(x = "Date", y = "Number of flights", title = "Distribution of flights per day in 2015")
```

- 4.2 Question 2: Are there any seasonal or time-of-day patterns in weather-related flight delays? For example, are flights more likely to be delayed during thunderstorms or during peak travel times?

I intend to explore the relationship between geographic location and flight delays. Are some airports or regions more likely to have flight delays? I took the average of the delay times for all delays, other delays and weather delays and compared them.



```{r}
flights_processed_2_df = flights_processed_df

flight_airport_delays_df = flights_processed_2_df %>% 
  group_by(ORIGIN_AIRPORT) %>% 
  summarize(TOTAL_FLIGHTS = n(),
            AVG_DELAY = mean(DEPARTURE_DELAY, na.rm = TRUE)) %>%
  filter(TOTAL_FLIGHTS > 100)

# find the top 10 most delayed airports
top_airports_df = flight_airport_delays_df %>%
  arrange(desc(AVG_DELAY)) %>%
  head(10)
 
ggplot(top_airports_df, aes(x = reorder(ORIGIN_AIRPORT, AVG_DELAY), y = AVG_DELAY)) +
  geom_bar(stat = "identity") +
  ggtitle("Top 10 Most Delayed Airports") +
  xlab("Destination Airport") + ylab("Mean Arrival Delay (minutes)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
flights_processed_2_df = flights_processed_df

flight_airport_delays_df = flights_processed_2_df %>% 
  group_by(ORIGIN_AIRPORT) %>% 
  summarize(AVG_OTHER_DELAY = mean(OTHER_DELAY, na.rm = TRUE))
  summarize()

# find the top 10 most delayed airports
top_airports_df = flight_airport_delays_df %>%
  arrange(desc(AVG_OTHER_DELAY)) %>%
  head(10)
 
ggplot(top_airports_df, aes(x = reorder(ORIGIN_AIRPORT, AVG_OTHER_DELAY), y = AVG_OTHER_DELAY)) +
  geom_bar(stat = "identity") +
  ggtitle("Top 10 Most Delayed Airports") +
  xlab("Destination Airport") + ylab("Mean Arrival Delay (minutes)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

- 4.3 Question 3: Can we distinguish between weather delayed and non-weather delayed flights based on weather data?

The original question was to investigate which weather variables influence the likelihood of flight delays the most. However I realized that this is more of a modelling problem. Instead I would like to compare ________ between weather delayed and non-weather delayed groups to see where we can distinguish between classes, and infer from there which weather factors are most important.



## 5. Analytical Plan


## 6. Appendix

## Data cleaning

```{r}

```

### Python Code to Extract Weather Data

```{r}

```

